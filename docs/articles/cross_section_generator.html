<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NOAA OWP Cross Section Generator • hydrofabric3D</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="NOAA OWP Cross Section Generator">
<meta name="description" content='"Adding Cross Sections to Hydrofabric Datasets"
'>
<meta property="og:description" content='"Adding Cross Sections to Hydrofabric Datasets"
'>
<meta property="og:image" content="/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">hydrofabric3D</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.1.86</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>NOAA OWP Cross Section Generator</h1>
                        <h4 data-toc-skip class="author">Mike
Johnson</h4>
            <address class="author_afil">
      Lynker, NOAA-Affiliate<br><div class="d-none name"><code>cross_section_generator.Rmd</code></div>
    </address>
</div>

    
    
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>The need to cut transects of elevation along a set of lines
(e.g. river or road networks) is a fairly common task with an
unsatisfying number of off the shelf solutions. For our particular need
at OWP we need to cut cross sections across the entire CONUS river
network to provide much needed information to flood mapping and
hydrologic modeling tasks. This document shows some of the initial
efforts towards doing this at that scale. For small sets of cross
sections the tools developed by Rich McDonald
(e.g. nhdplusTools::get_xs_point) should be preferred.</p>
</div>
<div class="section level3">
<h3 id="prep-network">Prep Network<a class="anchor" aria-label="anchor" href="#prep-network"></a>
</h3>
<p>Here we are loading the Upper Tributary of COMID 101. In total there
are 325 flowlines with a total length of 942.3 km.</p>
<p>We also prescribe a floodplain width by computing the estimated bank
full width (from literature based power-law) and multiplying it by 5.
This assumes 2 parts left-bank, 1 part in channel (bank full), 2 parts
right-bank. This will be important latter!</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flood_plain_sections</span> <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="va">network</span> <span class="op">=</span> <span class="va">linestring</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="co"># https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2013WR013916</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>bf_width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.700</span>    <span class="op">+</span> <span class="fl">0.365</span><span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">totdasqkm</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         cs_width <span class="op">=</span> <span class="va">flood_plain_sections</span> <span class="op">*</span> <span class="va">bf_width</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="algorithm-walk-through">Algorithm Walk Through:<a class="anchor" aria-label="anchor" href="#algorithm-walk-through"></a>
</h3>
<p>Our algorithm works by generating a set of edges from a single line
string, and computing normal vector, that are transformed with a series
of afline transformations. To illustrate this lets start with a single
flowline:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">linestring</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">network</span>, <span class="va">comid</span> <span class="op">==</span> <span class="fl">101</span><span class="op">)</span></span></code></pre></div>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="section level4">
<h4 id="step-1-explode-linestring-into-edges">Step 1: Explode Linestring into edges:<a class="anchor" aria-label="anchor" href="#step-1-explode-linestring-into-edges"></a>
</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sf --&gt; geos object</span></span>
<span> <span class="va">line</span> <span class="op">&lt;-</span> <span class="fu">as_geos_geometry</span><span class="op">(</span><span class="va">linestring</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># extract vertices</span></span>
<span> <span class="va">vertices</span> <span class="op">&lt;-</span> <span class="fu">wk_vertices</span><span class="op">(</span><span class="va">line</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># Use vertices to reconstruct line segments</span></span>
<span>  <span class="va">edges</span> <span class="op">&lt;-</span> <span class="fu">as_geos_geometry</span><span class="op">(</span></span>
<span>    <span class="fu">wk_linestring</span><span class="op">(</span></span>
<span>      <span class="va">vertices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>      feature_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="step-2-define-edge-mid-and-end-point">Step 2: Define Edge Mid and End Point<a class="anchor" aria-label="anchor" href="#step-2-define-edge-mid-and-end-point"></a>
</h4>
<p>The next steps are down for each individual edge in the exploded
linestring:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Starting with just the first edge</span></span>
<span><span class="va">edge</span>  <span class="op">&lt;-</span>  <span class="va">edges</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span><span class="co"># Define a width of desired cross section</span></span>
<span><span class="va">width</span> <span class="op">&lt;-</span>  <span class="va">linestring</span><span class="op">$</span><span class="va">cs_width</span></span>
<span></span>
<span><span class="co"># find the midpoint</span></span>
<span><span class="va">midpoint</span> <span class="op">&lt;-</span> <span class="fu">geos_interpolate_normalized</span><span class="op">(</span><span class="va">edge</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="co"># find the end point</span></span>
<span><span class="va">ep</span>       <span class="op">&lt;-</span> <span class="fu">geos_point_end</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span></span></code></pre></div>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="step-3-define-cross-section-at-end-point">Step 3: Define Cross Section at end Point<a class="anchor" aria-label="anchor" href="#step-3-define-cross-section-at-end-point"></a>
</h4>
<p>To generate a cross section that passes through the end point we need
to steps</p>
<div class="section level5">
<h5 id="define-a-normal-edge">Define a normal edge<a class="anchor" aria-label="anchor" href="#define-a-normal-edge"></a>
</h5>
<p>3 transformations to define a normal edge:</p>
<ol style="list-style-type: decimal">
<li><p><code>affine_translate</code>: define the coordinate offsets in
the x, y direction as the negative value of the X and Y coordinate of
the edge midpoint</p></li>
<li><p><code>affine_scale</code>: apply an X scale factor of 1/length of
the edge, and a Y scale factor of 1/length of the edge</p></li>
<li><p><code>Rotate</code> the new line 90 degrees</p></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">normal_edge</span> <span class="op">&lt;-</span> <span class="fu">wk_transform</span><span class="op">(</span><span class="va">edge</span>, </span>
<span>                                <span class="fu">wk_affine_compose</span><span class="op">(</span></span>
<span>            <span class="fu">wk_affine_translate</span><span class="op">(</span>dx <span class="op">=</span> <span class="op">-</span><span class="fu">geos_x</span><span class="op">(</span><span class="va">midpoint</span><span class="op">)</span>, dy <span class="op">=</span> <span class="op">-</span><span class="fu">geos_y</span><span class="op">(</span><span class="va">midpoint</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu">wk_affine_scale</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu">geos_length</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu">geos_length</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            <span class="fu">wk_affine_rotate</span><span class="op">(</span><span class="fl">90</span><span class="op">)</span></span>
<span>  <span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level5">
<h5 id="define-the-cross-sections">Define the cross sections<a class="anchor" aria-label="anchor" href="#define-the-cross-sections"></a>
</h5>
<p>2 transformations are needed to define a cross section:</p>
<ol style="list-style-type: decimal">
<li><p><code>affine_scale</code>: apply an X scale factor of the desired
width, and a Y scale factor of the desired width</p></li>
<li><p><code>affine_translate</code>: define the coordinate offsets in
the x, y direction as the negative value of the X and Y coordinate of
the edge end point</p></li>
</ol>
<p>Lastly, the CRS of the original line is reassigned.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cs</span> <span class="op">=</span> <span class="fu">wk_set_crs</span><span class="op">(</span><span class="fu">wk_transform</span><span class="op">(</span></span>
<span>    <span class="va">normal_edge</span>,</span>
<span>    <span class="fu">wk_affine_compose</span><span class="op">(</span></span>
<span>      <span class="fu">wk_affine_scale</span><span class="op">(</span><span class="va">width</span>, <span class="va">width</span><span class="op">)</span>,</span>
<span>      <span class="fu">wk_affine_translate</span><span class="op">(</span><span class="fu">geos_x</span><span class="op">(</span><span class="va">ep</span><span class="op">)</span>, <span class="fu">geos_y</span><span class="op">(</span><span class="va">ep</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span>, <span class="fu">wk_crs</span><span class="op">(</span><span class="va">line</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="cut-a-full-flowline">Cut a Full Flowline<a class="anchor" aria-label="anchor" href="#cut-a-full-flowline"></a>
</h2>
<p>Using the above logic, we can write a function that generates a
series of cross sections for each edge in the line string:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Make a function:</span></span>
<span><span class="va">cut_transect</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">edge</span>, <span class="va">width</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>  <span class="va">midpoint</span> <span class="op">&lt;-</span> <span class="fu">geos_interpolate_normalized</span><span class="op">(</span><span class="va">edge</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span>  <span class="va">ep</span>       <span class="op">&lt;-</span> <span class="fu">geos_point_end</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">normale_edge</span> <span class="op">&lt;-</span> <span class="fu">wk_transform</span><span class="op">(</span><span class="va">edge</span>, </span>
<span>                                  <span class="fu">wk_affine_compose</span><span class="op">(</span></span>
<span>              <span class="fu">wk_affine_translate</span><span class="op">(</span>dx <span class="op">=</span> <span class="op">-</span><span class="fu">geos_x</span><span class="op">(</span><span class="va">midpoint</span><span class="op">)</span>, dy <span class="op">=</span> <span class="op">-</span><span class="fu">geos_y</span><span class="op">(</span><span class="va">midpoint</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="fu">wk_affine_scale</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu">geos_length</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span>, <span class="fl">1</span> <span class="op">/</span> <span class="fu">geos_length</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="fu">wk_affine_rotate</span><span class="op">(</span><span class="fl">90</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="fu">wk_set_crs</span><span class="op">(</span><span class="fu">wk_transform</span><span class="op">(</span></span>
<span>      <span class="va">normale_edge</span>,</span>
<span>      <span class="fu">wk_affine_compose</span><span class="op">(</span></span>
<span>        <span class="fu">wk_affine_scale</span><span class="op">(</span><span class="va">width</span>, <span class="va">width</span><span class="op">)</span>,</span>
<span>        <span class="fu">wk_affine_translate</span><span class="op">(</span><span class="fu">geos_x</span><span class="op">(</span><span class="va">ep</span><span class="op">)</span>, <span class="fu">geos_y</span><span class="op">(</span><span class="va">ep</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span>, <span class="fu">wk_crs</span><span class="op">(</span><span class="va">edge</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">all</span> <span class="op">=</span> <span class="fu">vec_c</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span><span class="va">cut_transect</span>, <span class="va">edges</span>, width <span class="op">=</span> <span class="va">linestring</span><span class="op">$</span><span class="va">cs_width</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   0.019   0.000   0.019</span></span></code></pre>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>OK that’s pretty good! But there are a few things I don’t like. From
here on out we must enforce the following two conditions:</p>
<ul>
<li><p><strong>Condition 1</strong>: Cross sections should <em>not</em>
cross each other</p></li>
<li><p><strong>Condition 2</strong>: A single cross section should not
cross a given reach more then once</p></li>
</ul>
<p>Predicates like <code>st_intersect</code> cannot be run at the end
without wiping <em>all</em> cross-sections that intersect. So, we need
to implement some logic to enforce these:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">get_transects</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">edges</span>, <span class="va">line</span>, <span class="va">width</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">width</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">width</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">transects</span> <span class="op">&lt;-</span> <span class="fu">geos_empty</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">tran</span> <span class="op">=</span> <span class="fu"><a href="../reference/cut_transect.html">cut_transect</a></span><span class="op">(</span><span class="va">edges</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">width</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># If a MULTIPOINT, then it crosses more the once</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu">geos_type</span><span class="op">(</span><span class="fu">geos_intersection</span><span class="op">(</span><span class="va">tran</span>, <span class="va">line</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="st">"point"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Ensure that there are no intersections with previously computed cross sections</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu">geos_intersects</span><span class="op">(</span><span class="va">tran</span>, <span class="va">transects</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">transects</span> <span class="op">&lt;-</span>  <span class="fu">vec_c</span><span class="op">(</span><span class="va">transects</span>, <span class="va">tran</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">transects</span><span class="op">[</span><span class="op">!</span><span class="fu">geos_is_empty</span><span class="op">(</span><span class="va">transects</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span> <span class="va">transects</span> <span class="op">=</span>  <span class="fu"><a href="../reference/get_transects.html">get_transects</a></span><span class="op">(</span><span class="va">edges</span>, <span class="va">line</span>, width <span class="op">=</span> <span class="fl">250</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##    0.03    0.00    0.03</span></span></code></pre>
<p>Awesome! We gained just a fraction of time while ensuring a set of
valid cross sections are generated.</p>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
<div class="section level3">
<h3 id="flow-network">Flow Network<a class="anchor" aria-label="anchor" href="#flow-network"></a>
</h3>
<p>OK, so we have gone from a single edge, to a full flowline. Now - how
about a full network! Again, this requires looping over all flowlines.
Additionally we add a few new items:</p>
<ul>
<li>The <code>num</code> argument allows a user to restrict the number
of cross sections desired per flowline.</li>
<li>The <code>crosswalk_id</code> argument allows a user to specify the
identifier column of the input. If provided these will be assigned as
the “hy_id” in the output. If not prescribed, a 1:n() index will be
added.</li>
<li>The outputs will also have a 1:n() cs_id describing the ordered set
of cross sections where 1 is the most upstream and n is the most
downstream.</li>
<li>Lastly, a final pass is made to remove all cross sections that
intersect with cross section from a different flowline.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cut_cross_sections</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">net</span>, <span class="va">crosswalk_id</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">widths</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">num</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">ll</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">widths</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">widths</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">widths</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>   <span class="va">line</span> <span class="op">&lt;-</span> <span class="fu">as_geos_geometry</span><span class="op">(</span><span class="va">net</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span><span class="op">)</span></span>
<span>    </span>
<span>   <span class="va">vertices</span> <span class="op">&lt;-</span> <span class="fu">wk_vertices</span><span class="op">(</span><span class="va">line</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="va">edges</span> <span class="op">&lt;-</span> <span class="fu">as_geos_geometry</span><span class="op">(</span></span>
<span>      <span class="fu">wk_linestring</span><span class="op">(</span></span>
<span>        <span class="va">vertices</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>,</span>
<span>        feature_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">vertices</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>   </span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">num</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">edges</span> <span class="op">=</span> <span class="va">edges</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq.int</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">edges</span><span class="op">)</span>, length.out <span class="op">=</span> <span class="va">num</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="va">ll</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/get_transects.html">get_transects</a></span><span class="op">(</span><span class="va">edges</span>, <span class="va">line</span>, <span class="va">widths</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">ids_length</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">ll</span><span class="op">)</span></span>
<span>  <span class="va">ll</span> <span class="op">=</span> <span class="fu">st_as_sf</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span><span class="va">c</span>,<span class="va">ll</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">crosswalk_id</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">ll</span><span class="op">$</span><span class="va">hy_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">net</span><span class="op">[[</span><span class="va">crosswalk_id</span><span class="op">]</span><span class="op">]</span>, times <span class="op">=</span> <span class="va">ids_length</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>     <span class="va">ll</span><span class="op">$</span><span class="va">hy_id</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">net</span><span class="op">)</span>, times <span class="op">=</span> <span class="va">ids_length</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">ll</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="fu">st_intersects</span><span class="op">(</span><span class="va">ll</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">hy_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cs_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">oo</span> <span class="op">=</span> <span class="fu"><a href="../reference/cut_cross_sections.html">cut_cross_sections</a></span><span class="op">(</span>net <span class="op">=</span> <span class="va">network</span>, </span>
<span>                          crosswalk_id <span class="op">=</span> <span class="st">"comid"</span>, </span>
<span>                          widths <span class="op">=</span> <span class="va">network</span><span class="op">$</span><span class="va">cs_width</span>,</span>
<span>                          num <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   2.043   0.013   2.056</span></span></code></pre>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-17-1.png" width="700"><img src="cross_section_generator_files/figure-html/unnamed-chunk-17-2.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="transects-to-3d-channel">Transects to 3D channel<a class="anchor" aria-label="anchor" href="#transects-to-3d-channel"></a>
</h3>
<p>To turn the extracted transect set into “3D” cross sections, we need
to define a set number of points to sample along each line, and then use
those to extract an elevation from a DEM. Here, we use a VRT file of the
10m 3DEP elevation data that we produced for the National Map with
support from the 3DEP team.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="va">points_per_cs</span> <span class="op">=</span> <span class="fl">35</span></span>
<span><span class="va">elev_url</span> <span class="op">=</span> <span class="st">"/vsicurl/https://prd-tnm.s3.amazonaws.com/StagedProducts/Elevation/13/TIFF/USGS_Seamless_DEM_13.vrt"</span></span>
<span></span>
<span><span class="va">extract_pt_val</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">rast</span>, <span class="va">pts</span><span class="op">)</span><span class="op">{</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">rast</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/project.html" class="external-link">project</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/vect.html" class="external-link">vect</a></span><span class="op">(</span><span class="va">pts</span><span class="op">)</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/crs.html" class="external-link">crs</a></span><span class="op">(</span><span class="va">rast</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">cs_pts</span> <span class="op">=</span> </span>
<span>      <span class="fu">st_set_geometry</span><span class="op">(</span><span class="va">oo</span>, <span class="fu">st_line_sample</span><span class="op">(</span><span class="va">oo</span>, <span class="va">points_per_cs</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu">st_cast</span><span class="op">(</span><span class="st">"POINT"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu">st_transform</span><span class="op">(</span><span class="fu">st_crs</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">elev_url</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Z   <span class="op">=</span> <span class="fu">extract_pt_val</span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/rast.html" class="external-link">rast</a></span><span class="op">(</span><span class="va">elev_url</span><span class="op">)</span>, <span class="va">.</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">hy_id</span>, <span class="va">cs_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pt_id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##   4.321   0.170  17.145</span></span></code></pre>
<p><img src="cross_section_generator_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="reach-addressing">Reach Addressing<a class="anchor" aria-label="anchor" href="#reach-addressing"></a>
</h2>
<p>A key for hydrologic locations is a linear reference that describes
the percentage along a reach a location sits. To reference the center of
each cross section, we can use the flowline indexing tools in
nhdplusTools:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="co"># Find middle point of each cross section</span></span>
<span>  <span class="va">tmp</span> <span class="op">=</span> <span class="va">cs_pts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">hy_id</span>, <span class="va">cs_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">pt_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu">st_transform</span><span class="op">(</span><span class="fl">5070</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Add the needed information to our network object, and fine flowline index</span></span>
<span>  <span class="va">xx</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">network</span>, </span>
<span>                 <span class="fu">get_vaa</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tomeas"</span>, <span class="st">"frommeas"</span>, <span class="st">'reachcode'</span><span class="op">)</span>, updated_network <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, </span>
<span>                 by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"comid"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>     <span class="fu">get_flowline_index</span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>cs_id <span class="op">=</span> <span class="va">tmp</span><span class="op">$</span><span class="va">cs_id</span><span class="op">[</span><span class="va">crosswalk_id</span><span class="op">]</span>, crosswalk_id <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>hy_id <span class="op">=</span> <span class="va">COMID</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># add new information of cs_pts and rearrange columns</span></span>
<span>  <span class="va">cs_pts</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">cs_pts</span>, <span class="va">xx</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hy_id"</span>, <span class="st">"cs_id"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">hy_id</span>, <span class="va">cs_id</span>, <span class="va">pt_id</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span>  </span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/headtail.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cs_pts</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="channel-classifiction">Channel Classifiction<a class="anchor" aria-label="anchor" href="#channel-classifiction"></a>
</h2>
<p>OK so now we have cut cross sections along network, sampled them and
extracted depths, and addressed them to the hydrologic network! Now, we
want to to assign a classification to each point marking it as
“right_bank”, “in_channel” and “left_bank”.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">assign_class</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">Z</span>, <span class="va">ratio</span> <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">{</span> </span>
<span>  </span>
<span>  <span class="co"># The change in elevation across the cross section</span></span>
<span>  <span class="va">dY</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="co"># devise a threshold for each section based on the prescribed ratio</span></span>
<span>  <span class="va">thres</span> <span class="op">=</span> <span class="va">ratio</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span></span>
<span>  <span class="co"># Assume the left side is 2* threshold</span></span>
<span>  <span class="va">la</span> <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="va">thres</span></span>
<span>  <span class="co"># Assume the channel is the left edge plus one part.</span></span>
<span>  <span class="va">ca</span> <span class="op">=</span> <span class="va">la</span><span class="op">:</span><span class="op">(</span><span class="va">thres</span> <span class="op">+</span> <span class="va">la</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Assume the channel sits within the middle part + or minus a part</span></span>
<span>  <span class="va">mid_sec</span> <span class="op">=</span> <span class="va">Z</span><span class="op">[</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">thres</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">-</span><span class="fl">2</span><span class="op">*</span><span class="va">thres</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">mid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">Z</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">mid_sec</span><span class="op">)</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="va">mid</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">*</span><span class="va">thres</span> <span class="op">|</span> <span class="va">mid</span> <span class="op">&gt;</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">thres</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">mid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">mid_sec</span><span class="op">)</span> </span>
<span>    <span class="va">mid</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">median</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mid_sec</span> <span class="op">==</span> <span class="va">mid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">thres</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">lb</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">dY</span><span class="op">[</span><span class="op">(</span><span class="va">mid</span><span class="op">-</span><span class="va">thres</span><span class="op">)</span><span class="op">:</span><span class="va">mid</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">mid</span><span class="op">-</span><span class="va">thres</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span></span>
<span>  </span>
<span>  <span class="va">rb</span> <span class="op">=</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/summarize-generics.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">dY</span><span class="op">[</span><span class="op">(</span><span class="va">mid</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="va">mid</span><span class="op">+</span><span class="va">thres</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>  <span class="op">+</span> <span class="va">mid</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>  </span>
<span>  <span class="va">class</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"in_channel"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">class</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">lb</span><span class="op">]</span> <span class="op">=</span> <span class="st">"left_bank"</span></span>
<span>  <span class="va">class</span><span class="op">[</span><span class="va">rb</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="st">"right_bank"</span></span>
<span>  </span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op">!=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Z</span><span class="op">)</span> <span class="op">|</span>  <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">class</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"left_bank"</span>, <span class="fl">2</span><span class="op">*</span><span class="va">thres</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">'in_channel'</span>, <span class="va">thres</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"right_bank"</span>, <span class="fl">2</span><span class="op">*</span><span class="va">thres</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="va">class</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="op">{</span></span>
<span>  <span class="va">cs_pts</span> <span class="op">=</span> <span class="va">cs_pts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">hy_id</span>, <span class="va">cs_id</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu">assign_class</span><span class="op">(</span><span class="va">Z</span>, ratio <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="va">flood_plain_sections</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">mapview</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html" class="external-link">mapview</a></span><span class="op">(</span><span class="va">network</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="channel-bottom-alignment-and-bank-smoothing">Channel bottom alignment and bank smoothing<a class="anchor" aria-label="anchor" href="#channel-bottom-alignment-and-bank-smoothing"></a>
</h2>
<p>Lastly, for a successful routing implementation, we need to ensure
that the bottom of each cross section is lower then or equal to that one
upstream. Here we will traverse down the network making sure this
condition is met, and, in cases where it isn’t, we will lower the in
channel portion of the cross section to make it so:</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/mikejohnson51" class="external-link">Mike Johnson</a>, <a href="https://github.com/anguswg-ucsb" class="external-link">Angus Watters</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
